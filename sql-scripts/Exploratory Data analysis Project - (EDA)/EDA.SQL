use datawarehouse

select * from  gold.fact_sales
select * from  gold.dim_products
select * from  gold.dim_customers

select
avg(datediff(year,birthday, GETDATE())) as age 
from gold.dim_customers

select * from gold.dim_customers

--Database exploration--
--Explore all objests in the database
select * from INFORMATION_SCHEMA.TABLES

--Explore all column in the database
select * from INFORMATION_SCHEMA.COLUMNS

---
SELECT * FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'dim_customers'

--FIND NUMBER OF COLUMN NAMES IN A TABLE
SELECT COUNT(COLUMN_NAME)
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'dim_customers'
AND TABLE_SCHEMA = 'gold';


----#Dimensions Exploration----
select distinct(country) from gold.dim_customers
select count(distinct(country)) from gold.dim_customers


select distinct category,subcategory, product_name from gold.dim_products
order by 1,2,3

---Date Exploration---
--Find the data of the first and last order date
--Find how many years of sales are avaiable
select 
min(order_date) as first_order_date,
max(order_date) as last_order_date,
DATEDIFF(year, min(order_date), max(order_date)) as order_range_years
from gold.fact_sales

--Find the youngest and oldest customer--
select 
min(birthday) as oldest_birthdate,
DATEDIFF(year, max(birthday), GETDATE()) as oldest_age, --Youngest,
max(birthday) as youngest_birthdate,
DATEDIFF(year, min(birthday), GETDATE()) as oldest_age --oldest_age
from gold.dim_customers

---AGE Calculation
select 
DATEDIFF(year, birthday, GETDATE()) as age
from gold.dim_customers

--Measure Exploration---
--Find the Total sales
Select sum(sales) as total_sales from gold.fact_sales

--Find how many items are sold
Select sum(quantity) as total_quantity from gold.fact_sales

--Find the average selling price
select avg(price) as avg_price from gold.fact_sales

--Find the total number of orders
Select COUNT(order_number) as total_orders from gold.fact_sales

--Find the number of product
select count(distinct product_name) as total_orders from  gold.dim_products

--Find the total number of customers
select COUNT(customer_id) as Total_cus from gold.dim_customers

--Find the total number of customer that has placed an order
select COUNT(distinct customer_key) as Total_cus from gold.fact_sales


---Key Metrics values---
Select 'Total Sales' as measure_name, sum(sales) as Measure_values from gold.fact_sales
union all
Select 'Total quantity' as measure_name, sum(quantity) as Measure_values from gold.fact_sales
union all
select 'Avg proce' as measure_name, avg(price) as Measure_values from gold.fact_sales
union all 
Select 'Total Nr.Orders' as measure_name, COUNT(order_number) as Measure_values from gold.fact_sales
union all 
select 'Total Nr.Product' as measure_name, count(distinct product_name) as measure_name from  gold.dim_products
union all
select 'Total Nr.Customers' as measure_name, COUNT(distinct customer_key) as measure_name from gold.fact_sales

------Magnitude Analysis------
--Find total customers by countries
select 
country,
count(customer_key) as total_customers
from gold.dim_customers
group by country
order by total_customers desc

---Find total customers by gender
select
gender,
count(customer_id) as total_gender
from  gold.dim_customers
group by gender
order by total_gender desc

--Find total product by category
select 
category,
count(product_key) as total_count
from gold.dim_products
group by category
order by total_count desc

--What is the average costs in each category?
select 
category,
avg(cost) as avg_cost
from gold.dim_products
group by category
order by avg_cost desc

--What is the toal reveune generated for each category?

select
pd.category,
sum(ft.sales) as total_revenue
from gold.fact_sales ft
left join gold.dim_products pd
on ft.product_key = pd.product_key
group by category
order by total_revenue desc

--What is the total revenue generated by each customers?

select 
c.customer_key,
c.first_name,
c.last_name,
sum(f.sales) as total_revenue
 from gold.fact_sales f
left join gold.dim_customers c
on f.customer_key = c.customer_key
where c.customer_key = 430
group by 
c.customer_key,
c.first_name,
c.last_name
having sum(f.sales) <10000
order by total_revenue desc

use datawarehouse
--Ranking Analysis----
--Which 5 Product generate the highest revenue?
select top 5
pd.product_name,
sum(f.sales) as total_revenue
from gold.fact_sales f
left join gold.dim_products pd
on f.product_key = pd.product_key
group by pd.product_name 
order by total_revenue desc

----Bottom 5 products 
select top 5
pd.product_name,
sum(f.sales) as total_revenue
from gold.fact_sales f
left join gold.dim_products pd
on f.product_key = pd.product_key
group by pd.product_name 
order by total_revenue 

--Using window functions
select * 
from (
	select 
	pd.product_name,
	sum(f.sales) as total_revenue,
	dense_rank() over (order by sum(f.sales) desc) as prod_rank
	from gold.fact_sales f
	left join gold.dim_products pd
	on f.product_key = pd.product_key
	group by pd.product_name ) t
where prod_rank <=5

--Find the top 10 csutomers who as generated the hgiest revenue

select * from(
	select
	c.customer_key,
	c.first_name,
	c.last_name,
	sum(f.sales) as Total_revenue,
	DENSE_RANK() over (order by sum(f.sales) desc ) as top_cusomers
	from gold.fact_sales f
	left join gold.dim_customers c
	on f.customer_key = c.customer_key
	group by 
	c.customer_key,
	c.first_name,
	c.last_name) t
where top_cusomers <= 10

--The 3 customer with the fewest oders placed

select top 3
c.customer_key,
c.first_name,
c.last_name, 
count(distinct f.order_number) total_orders
from gold.fact_sales f
left join gold.dim_customers c
on f.customer_key = c.customer_key
group by 
c.customer_key,
c.first_name,
c.last_name
order by total_orders






